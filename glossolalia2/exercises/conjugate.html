<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<script src="../data/verbVocab.js"></script>
<title>Glossolalia Conjugation Game</title>


<style>
    /* ========= GLOBAL PAGE STYLES ========= */
    body {
        font-family: "Open Sans", Arial, sans-serif;
        max-width: 800px;
        margin: auto;
        padding: 20px;
        text-align: center;
        background: #f9f9f9;
    }
    
    h1 {
        color: #74B3CE;
        margin-bottom: 10px;
    }
    
    /* ========= BUTTONS ========= */
    button {
        background-color: #74B3CE;
        color: white;
        border: none;
        padding: 10px 22px;
        margin: 10px;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1.1rem;
        transition: background .25s ease;
    }
    button:hover {
        background-color: #5c96ae;
    }
    
    /* ========= POST-GAME PANEL ========= */
    #postGamePanel {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.5s ease;
        margin-top: 25px;
    }
    
    .game-space {
    margin-top: 20px;
    min-height: 60vh;       /* gives space to center */
    display: flex;
    flex-direction: column;
    justify-content: center;   /* vertical align */
    align-items: center;       /* horizontal align */
}

</style>
    
</head>

<body>

<!-- ==========================================================
     GAME SCREEN
     ========================================================== -->
<div id="gameScreen" style="display:none;">
  <h1 id="gameTitle"></h1>

  <div id="gameSpace" class="game-space"></div>

  <div id="postGamePanel">
    <button onclick="playAgain()">Play Again</button>
    <button onclick="goHome()">Home</button>
  </div>
</div>

<script>
/* ==========================================================
   Vocabulary 
   ========================================================== */



function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

let baseLanguageParam = getQueryParam("baseLang") || "English"; 
let targetLanguageParam = getQueryParam("targetLang") || "Finnish";
let currentTenseParam = getQueryParam("tenseSelect") || "present";

const verbVocab = verbData["verbs"].filter(verb => verb.data[targetLanguageParam] && verb.data[baseLanguageParam]);
const pronominalVocab = verbData["pronouns"].filter(pronoun => pronoun[targetLanguageParam] && pronoun[baseLanguageParam]);
console.log(verbVocab);
console.log(pronominalVocab);
console.log(pronominalVocab[targetLanguageParam]);

/* ============================
   ONE-ITEM-AT-A-TIME ENGINE
   ============================ */

let rounds = 5;          // how many exercises per game
let currentRound = 0; // current exercise number
let currentAnswer = "";  // stores the correct answer
let score = 0; // number of correct answers
let usedCombos = new Set();

function startGame() {
    currentRound = 0;
    score = 0;
    usedCombos.clear();
    document.getElementById("gameScreen").style.display = "block";
    document.getElementById("gameTitle").textContent = `Conjugation Practice`;
    document.getElementById("postGamePanel").style.visibility = "hidden";
    document.getElementById("postGamePanel").style.opacity = 0;

    loadNextExercise();
}

function resolvePronoun(pronounObj) {
    if (typeof pronounObj === "object" && pronounObj !== null) {
        const keys = Object.keys(pronounObj);
        const randomKey = keys[Math.floor(Math.random() * keys.length)];
        return pronounObj[randomKey];
    }
    return pronounObj;
}

function getExercise(baseLang, targetLang, tense, personKeys) {
    let verbIndex = Math.floor(Math.random() * verbVocab.length);

    // Just using the first verb for now
    const verb = verbVocab[verbIndex];
    const baseForms = verb.data[baseLang][tense];
    const targetForms = verb.data[targetLang][tense];
    const targetInf = verb.data[targetLang].infinitive;
    const pronouns = verbData.pronouns[0];
    // Pick one random person
    let personKey = shuffleArray([...personKeys])[0];

    let pronounBaseRaw = pronouns[baseLang][personKey];
    let pronounTargetRaw = pronouns[targetLang][personKey];

    let pronounBase = resolvePronoun(pronounBaseRaw);
    let pronounTarget = resolvePronoun(pronounTargetRaw);


    const baseCue = `${pronounBase} ${baseForms[personKey]}`;

    if (usedCombos.has(baseCue)) {
        return getExercise(baseLang, targetLang, tense, personKeys);  // try again
    } else {
        usedCombos.add(baseCue);
        return {
            baseCue,
            pronounTarget,
            targetInf,
            targetForms,
            personKey
        };
    }
    
}

function loadNextExercise() {
    const baseLang = baseLanguageParam;
    const targetLang = targetLanguageParam;
    const tense = currentTenseParam;

    const personKeys = [
        "firstPersonSingular",
        "secondPersonSingular",
        "thirdPersonSingular",
        "firstPersonPlural",
        "secondPersonPlural",
        "thirdPersonPlural"
    ];

    data = getExercise(baseLang, targetLang, tense, personKeys);
    const { baseCue, pronounTarget, targetInf, targetForms, personKey } = data;

    currentAnswer = targetForms[personKey];

    const grid = document.getElementById("gameSpace");
    grid.innerHTML = `
        <div class="clozeItem">
            <p><strong>${baseCue}</strong></p>

            <p>
                ${pronounTarget} <em>(${targetInf})</em>
                <input type="text" id="answerBox" autofocus />
            </p>

            <button id="submitBtn">Submit</button>

            <p id="feedback" style="font-weight:bold; margin-top:10px; height:20px"></p>
        </div>
    `;

    const feedback = document.getElementById("feedback");
    
    document.getElementById("submitBtn").addEventListener("click", handleSubmit);
    document.getElementById("answerBox").focus();
    // alternative submit with "enter" key 
    document.getElementById("answerBox").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            handleSubmit();
        }
    });
}

function handleSubmit() {
    const user = document.getElementById("answerBox").value.trim().toLowerCase();
    const feedback = document.getElementById("feedback");

    if (user === currentAnswer.toLowerCase()) {
        feedback.textContent = `✓ Correct: ${currentAnswer}`;
        feedback.style.color = "green";
        score ++;
    } else {
        feedback.textContent = `✗ Incorrect — correct: ${currentAnswer}`;
        feedback.style.color = "red";
    }

    // Move to next round after 1s
    currentRound++;

    if (currentRound < rounds) {
        setTimeout(loadNextExercise, 1000);
    } else {
        setTimeout(showPostGame, 1000);
    }
}

function showPostGame() {
    const postPanel = document.getElementById("postGamePanel");
    postPanel.style.visibility = "visible";
    postPanel.style.opacity = 1;

    document.getElementById("gameSpace").innerHTML =
        `<p>Practice complete! You successfully answered ${score} / ${rounds} items.</p>`;
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

function playAgain() {
    startGame();
}

function goHome() {
    window.location.href = "../../../glossolalia.html";
}



startGame();

</script>

</body>
</html>
